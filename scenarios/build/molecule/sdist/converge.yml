---
- import_playbook: playbooks/preamble.yml

- name: Build binary distribution
  hosts: afs_builders
  collections:
    - openafs_contrib.openafs
  tasks:
    - import_role:
        name: openafs_devel

    - set_fact:
        afs_source: '~/openafs'
      when: afs_source is undefined

    - name: Checkout source
      git:
        repo: "{{ afs_git_repo | d('git@git.openafs.org/openafs.git') }}"
        version: "{{ afs_git_version | d('master') }}"
        dest: "{{ afs_source }}"

    - name: Determine version string
      command:
        cmd: build-tools/git-version .
        chdir: "{{ afs_source }}"
      changed_when: false
      register: git_version

    - set_fact:
        afs_version: "{{ git_version.stdout | replace('-', '_') }}"

    - name: Autoconf
      command:
        cmd: ./regen.sh
        chdir: "{{ afs_source }}"

    - name: Generate makefile
      command:
        cmd: ./configure --disable-kernel-module
        chdir: "{{ afs_source }}"

    - name: Create source distribution files
      command:
        cmd: make dist
        chdir: "{{ afs_source }}"

    - name: Create archive
      archive:
        path: "~/openafs/packages/"
        dest: "openafs-{{ afs_version }}-sdist.tar.gz"
        format: gz

    - name: Download
      fetch:
        flat: yes
        src: "openafs-{{ afs_version }}-sdist.tar.gz"
        dest: "{{ afs_builds }}/"
      register: fetch_results

    - name: Downloaded
      debug:
        var: fetch_results.dest
