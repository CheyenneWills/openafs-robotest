#!/bin/sh
#
# Solaris 11.3 setup notes:
#
# 1. 'pkg install' will return a non-zero exit code when attempting
#    to install a package that is already installed, so try to avoid
#    a false error by checking for the presence of the package before
#    installing.
#
# 2. The argparse module is bundled in runtime/python-27.
#
# 3. A fix to nm in 11.3 broke libtool.
#    See http://lists.gnu.org/archive/html/bug-libtool/2016-01/msg00000.html
#

die() {
    echo "$1" >&2
    exit 1
}

pkg_install() {
    if pkg verify -q $1 2>/dev/null; then
        :
    else
        echo "Installing '$1'."
        pkg install $1 || die "Failed to install '$1'."
    fi
}

patch_libtool() {
    if [ -f /usr/share/aclocal/libtool.m4.unpatched ]; then
        :
    else
        cp /usr/share/aclocal/libtool.m4 /usr/share/aclocal/libtool.m4.unpatched
        chmod +w /usr/share/aclocal/libtool.m4
        ( cd / ; cat <<_EOF_ | patch -p1 )
--- /usr/share/aclocal/libtool.m4.orig	Sun Aug 14 12:04:03 2016
+++ /usr/share/aclocal/libtool.m4	Sun Aug 14 12:05:55 2016
@@ -3651,7 +3651,7 @@
   symcode='[[BCDEGQRST]]'
   ;;
 solaris*)
-  symcode='[[BDRT]]'
+  symcode='[[BCDRT]]'
   ;;
 sco3.2v5*)
   symcode='[[DT]]'
_EOF_
    fi
}

pkg_install 'pkg://solaris/runtime/python-27'
pkg_install 'pkg://solaris/library/python/pip'
patch_libtool

